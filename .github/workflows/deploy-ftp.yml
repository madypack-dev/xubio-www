name: Deploy to Ferozo via FTP

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      deploy_protocol:
        description: "Protocol to use for deploy (ftp or sftp)"
        required: false
        default: "ftp"
        type: choice
        options:
          - ftp
          - sftp
      deploy_port:
        description: "Optional port override (default: 21 for ftp, 22 for sftp)"
        required: false
        default: ""
        type: string

concurrency:
  group: deploy-ftp-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DEPLOY_PROTOCOL: ${{ inputs.deploy_protocol || 'ftp' }}
      DEPLOY_PORT: ${{ inputs.deploy_port || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
        run: npm run build

      - name: Debug validate deploy secrets and DNS
        id: preflight
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          DEPLOY_PROTOCOL: ${{ env.DEPLOY_PROTOCOL }}
          DEPLOY_PORT: ${{ env.DEPLOY_PORT }}
        run: |
          set -euo pipefail
          protocol="$(echo "${DEPLOY_PROTOCOL:-ftp}" | tr '[:upper:]' '[:lower:]')"
          if [ "$protocol" != "ftp" ] && [ "$protocol" != "sftp" ]; then
            echo "ERROR: DEPLOY_PROTOCOL debe ser 'ftp' o 'sftp'. Valor actual: '$protocol'" >&2
            exit 1
          fi
          if [ -n "${DEPLOY_PORT:-}" ]; then
            target_port="$DEPLOY_PORT"
          elif [ "$protocol" = "sftp" ]; then
            target_port="22"
          else
            target_port="21"
          fi
          echo "Validating deploy secrets presence..."
          if [ -z "${FTP_SERVER:-}" ]; then
            echo "ERROR: FTP_SERVER is empty or not set in repository secrets." >&2
            exit 1
          fi
          if [ -z "${FTP_USERNAME:-}" ]; then
            echo "ERROR: FTP_USERNAME is empty or not set in repository secrets." >&2
            exit 1
          fi
          if [ -z "${FTP_PASSWORD:-}" ]; then
            echo "ERROR: FTP_PASSWORD is empty or not set in repository secrets." >&2
            exit 1
          fi

          raw_server="$FTP_SERVER"
          raw_server="${raw_server//$'\r'/}"
          raw_server="$(echo "$raw_server" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          raw_server="${raw_server#\"}"
          raw_server="${raw_server%\"}"
          raw_server="${raw_server#\'}"
          raw_server="${raw_server%\'}"
          normalized_server="$raw_server"
          normalized_server="${normalized_server#ftp://}"
          normalized_server="${normalized_server#ftps://}"
          normalized_server="${normalized_server#sftp://}"
          normalized_server="${normalized_server#http://}"
          normalized_server="${normalized_server#https://}"
          normalized_server="${normalized_server%%/*}"

          if [[ "$normalized_server" == \[*\]* ]]; then
            host_part="${normalized_server#\[}"
            host_part="${host_part%%\]*}"
          else
            host_part="${normalized_server%%:*}"
          fi

          if [ -z "$host_part" ]; then
            echo "ERROR: FTP_SERVER no contiene un host válido. Valor recibido: '$raw_server'" >&2
            exit 1
          fi

          if [[ "$host_part" =~ [[:space:]] ]]; then
            echo "ERROR: FTP_SERVER contiene espacios internos no válidos: '$host_part'" >&2
            exit 1
          fi

          if [ "$raw_server" != "$host_part" ]; then
            echo "WARN: FTP_SERVER tenía formato no recomendado ('$raw_server'). Se usará host normalizado: '$host_part'."
          fi

          echo "ftp_server_host=$host_part" >> "$GITHUB_OUTPUT"

          echo "Deploy protocol: $protocol"
          echo "Target port: $target_port"
          echo "Resolving hostname: $host_part"
          if command -v getent >/dev/null 2>&1; then
            if getent hosts "$host_part" >/dev/null 2>&1; then
              getent hosts "$host_part" | awk '{print "-> resolved: "$1" -> "$2}'
            else
              echo "ERROR: Hostname did not resolve via getent." >&2
              echo "Debug: host length=${#host_part}, ascii-safe='$host_part'"
              if command -v nslookup >/dev/null 2>&1; then
                echo "Debug: nslookup output (first lines):"
                nslookup "$host_part" | sed -n '1,10p' || true
              else
                echo "Debug: installing dnsutils for nslookup/dig..."
                sudo apt-get update -y >/dev/null
                sudo apt-get install -y dnsutils >/dev/null
                nslookup "$host_part" | sed -n '1,10p' || true
              fi
              if command -v dig >/dev/null 2>&1; then
                echo "Debug: dig A => $(dig +short A "$host_part" | tr '\n' ' ' || true)"
                echo "Debug: dig AAAA => $(dig +short AAAA "$host_part" | tr '\n' ' ' || true)"
              fi
              exit 1
            fi
          else
            echo "getent not available, attempting nslookup (installing dnsutils)..."
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y dnsutils >/dev/null
            if nslookup "$host_part" >/dev/null 2>&1; then
              nslookup "$host_part" | sed -n '1,5p'
            else
              echo "ERROR: Hostname did not resolve via nslookup." >&2
              exit 1
            fi
          fi
          echo "Testing TCP reachability on target port..."
          if command -v nc >/dev/null 2>&1; then
            if nc -z -w5 "$host_part" "$target_port" >/dev/null 2>&1; then
              echo "Port $target_port is reachable on $host_part"
            else
              echo "ERROR: Port $target_port is NOT reachable on $host_part" >&2
              exit 1
            fi
          else
            echo "nc not available; skipping port checks (install netcat if needed)."
          fi

      - name: Deploy dist via FTP
        if: ${{ env.DEPLOY_PROTOCOL == 'ftp' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.preflight.outputs.ftp_server_host }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: public_html/xubio-www/
          dangerous-clean-slate: false

      - name: Deploy dist via SFTP (SCP)
        if: ${{ env.DEPLOY_PROTOCOL == 'sftp' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.preflight.outputs.ftp_server_host }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ env.DEPLOY_PORT || '22' }}
          source: "dist/*"
          target: "public_html/xubio-www/"
