name: Deploy to Ferozo via FTP

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      deploy_protocol:
        description: "Protocol to use for deploy (ftps recommended, or ftp/sftp)"
        required: false
        default: "ftps"
        type: choice
        options:
          - ftps
          - ftps-legacy
          - ftp
          - sftp
      deploy_port:
        description: "Optional port override (default: 21 for ftp, 22 for sftp)"
        required: false
        default: ""
        type: string

concurrency:
  group: deploy-ftp-${{ github.ref }}
  cancel-in-progress: true

jobs:
  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

  build_dist:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          # Production build points to explicit backend URL from repository variables.
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
        run: npx vite build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: dist/
          if-no-files-found: error

  deploy_preflight:
    needs: [typecheck, build_dist]
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      DEPLOY_PROTOCOL: ${{ inputs.deploy_protocol || 'ftps' }}
      DEPLOY_PORT: ${{ inputs.deploy_port || '' }}
    outputs:
      deploy_port: ${{ steps.preflight.outputs.deploy_port }}
      deploy_protocol: ${{ steps.preflight.outputs.deploy_protocol }}

    steps:
      - name: Debug validate deploy secrets and DNS
        id: preflight
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_SERVER_IP: ${{ secrets.FTP_SERVER_IP }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          DEPLOY_PROTOCOL: ${{ env.DEPLOY_PROTOCOL }}
          DEPLOY_PORT: ${{ env.DEPLOY_PORT }}
        run: |
          set -euo pipefail
          protocol="$(echo "${DEPLOY_PROTOCOL:-ftp}" | tr '[:upper:]' '[:lower:]')"
          if [ "$protocol" != "ftp" ] && [ "$protocol" != "ftps" ] && [ "$protocol" != "ftps-legacy" ] && [ "$protocol" != "sftp" ]; then
            echo "ERROR: DEPLOY_PROTOCOL debe ser 'ftp', 'ftps', 'ftps-legacy' o 'sftp'. Valor actual: '$protocol'" >&2
            exit 1
          fi
          if [ -n "${DEPLOY_PORT:-}" ]; then
            target_port="$DEPLOY_PORT"
          elif [ "$protocol" = "sftp" ]; then
            target_port="22"
          elif [ "$protocol" = "ftps-legacy" ]; then
            target_port="990"
          else
            target_port="21"
          fi
          echo "Validating deploy secrets presence..."
          if [ -z "${FTP_SERVER:-}" ]; then
            echo "ERROR: FTP_SERVER is empty or not set in repository secrets." >&2
            exit 1
          fi
          if [ -z "${FTP_USERNAME:-}" ]; then
            echo "ERROR: FTP_USERNAME is empty or not set in repository secrets." >&2
            exit 1
          fi
          if [ -z "${FTP_PASSWORD:-}" ]; then
            echo "ERROR: FTP_PASSWORD is empty or not set in repository secrets." >&2
            exit 1
          fi

          raw_server="$FTP_SERVER"
          raw_server="${raw_server//$'\r'/}"
          raw_server="$(echo "$raw_server" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          raw_server="${raw_server#\"}"
          raw_server="${raw_server%\"}"
          raw_server="${raw_server#\'}"
          raw_server="${raw_server%\'}"
          normalized_server="$raw_server"
          normalized_server="${normalized_server#ftp://}"
          normalized_server="${normalized_server#ftps://}"
          normalized_server="${normalized_server#sftp://}"
          normalized_server="${normalized_server#http://}"
          normalized_server="${normalized_server#https://}"
          normalized_server="${normalized_server%%/*}"

          if [[ "$normalized_server" == \[*\]* ]]; then
            host_part="${normalized_server#\[}"
            host_part="${host_part%%\]*}"
          else
            host_part="${normalized_server%%:*}"
          fi

          if [ -z "$host_part" ]; then
            echo "ERROR: FTP_SERVER no contiene un host válido. Valor recibido: '$raw_server'" >&2
            exit 1
          fi

          if [[ "$host_part" =~ [[:space:]] ]]; then
            echo "ERROR: FTP_SERVER contiene espacios internos no válidos: '$host_part'" >&2
            exit 1
          fi

          if [ "$raw_server" != "$host_part" ]; then
            echo "WARN: FTP_SERVER tenía formato no recomendado ('$raw_server'). Se usará host normalizado: '$host_part'."
          fi

          echo "Deploy protocol: $protocol"
          echo "Target port: $target_port"
          resolved_target="$host_part"
          echo "Resolving hostname: $host_part"
          if command -v getent >/dev/null 2>&1; then
            if getent hosts "$host_part" >/dev/null 2>&1; then
              getent hosts "$host_part" | awk '{print "-> resolved: "$1" -> "$2}'
            else
              echo "ERROR: Hostname did not resolve via getent." >&2
              echo "Debug: host length=${#host_part}, ascii-safe='$host_part'"
              if command -v nslookup >/dev/null 2>&1; then
                echo "Debug: nslookup output (first lines):"
                nslookup "$host_part" | sed -n '1,10p' || true
              else
                echo "Debug: installing dnsutils for nslookup/dig..."
                sudo apt-get update -y >/dev/null
                sudo apt-get install -y dnsutils >/dev/null
                nslookup "$host_part" | sed -n '1,10p' || true
              fi
              if command -v dig >/dev/null 2>&1; then
                echo "Debug: dig A => $(dig +short A "$host_part" | tr '\n' ' ' || true)"
                echo "Debug: dig AAAA => $(dig +short AAAA "$host_part" | tr '\n' ' ' || true)"
              fi
              if [ -n "${FTP_SERVER_IP:-}" ]; then
                echo "WARN: DNS falló para '$host_part'. Se usará FTP_SERVER_IP como fallback."
                resolved_target="$FTP_SERVER_IP"
              else
                exit 1
              fi
            fi
          else
            echo "getent not available, attempting nslookup (installing dnsutils)..."
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y dnsutils >/dev/null
            if nslookup "$host_part" >/dev/null 2>&1; then
              nslookup "$host_part" | sed -n '1,5p'
            else
              echo "ERROR: Hostname did not resolve via nslookup." >&2
              if [ -n "${FTP_SERVER_IP:-}" ]; then
                echo "WARN: DNS falló para '$host_part'. Se usará FTP_SERVER_IP como fallback."
                resolved_target="$FTP_SERVER_IP"
              else
                exit 1
              fi
            fi
          fi
          echo "Resolved deploy target: $resolved_target"
          echo "deploy_port=$target_port" >> "$GITHUB_OUTPUT"
          echo "deploy_protocol=$protocol" >> "$GITHUB_OUTPUT"
          echo "Testing TCP reachability on target port..."
          if command -v nc >/dev/null 2>&1; then
            if nc -z -w5 "$resolved_target" "$target_port" >/dev/null 2>&1; then
              echo "Port $target_port is reachable on $resolved_target"
            else
              echo "ERROR: Port $target_port is NOT reachable on $resolved_target" >&2
              exit 1
            fi
          else
            echo "nc not available; skipping port checks (install netcat if needed)."
          fi

          echo "Resolved host computed for preflight checks."

  deploy_publish:
    needs: [deploy_preflight]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: dist/

      - name: Resolve server host for publish
        id: resolve_server
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
        run: |
          set -euo pipefail
          raw_server="$FTP_SERVER"
          raw_server="${raw_server//$'\r'/}"
          raw_server="$(echo "$raw_server" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          raw_server="${raw_server#\"}"
          raw_server="${raw_server%\"}"
          raw_server="${raw_server#\'}"
          raw_server="${raw_server%\'}"
          normalized_server="$raw_server"
          normalized_server="${normalized_server#ftp://}"
          normalized_server="${normalized_server#ftps://}"
          normalized_server="${normalized_server#sftp://}"
          normalized_server="${normalized_server#http://}"
          normalized_server="${normalized_server#https://}"
          normalized_server="${normalized_server%%/*}"
          if [[ "$normalized_server" == \[*\]* ]]; then
            host_part="${normalized_server#\[}"
            host_part="${host_part%%\]*}"
          else
            host_part="${normalized_server%%:*}"
          fi
          if [ -z "$host_part" ]; then
            echo "ERROR: FTP_SERVER no contiene host válido para publish" >&2
            exit 1
          fi
          echo "ftp_server_host=$host_part" >> "$GITHUB_OUTPUT"

      - name: Deploy dist via FTP/FTPS
        if: ${{ needs.deploy_preflight.outputs.deploy_protocol == 'ftp' || needs.deploy_preflight.outputs.deploy_protocol == 'ftps' || needs.deploy_preflight.outputs.deploy_protocol == 'ftps-legacy' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.resolve_server.outputs.ftp_server_host }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ${{ needs.deploy_preflight.outputs.deploy_protocol }}
          port: ${{ needs.deploy_preflight.outputs.deploy_port }}
          local-dir: dist/
          server-dir: public_html/xubio-www/
          dangerous-clean-slate: false

      - name: Deploy dist via SFTP (SCP)
        if: ${{ needs.deploy_preflight.outputs.deploy_protocol == 'sftp' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.resolve_server.outputs.ftp_server_host }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ needs.deploy_preflight.outputs.deploy_port }}
          source: "dist/*"
          target: "public_html/xubio-www/"
